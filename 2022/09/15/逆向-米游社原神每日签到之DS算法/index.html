<!DOCTYPE html><html class="appearance-auto" lang="zh-CN"><head><meta charset="UTF-8"><title>[逆向] 米游社原神每日签到之DS算法</title><meta name="description" content="Bzi-Han's blog, Bzi-Han的博客"><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><!-- Google Analytics --><!-- End Google Analytics -->
<!-- Baidu Analytics --><!-- End Baidu Analytics --><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><script src="/js/highlight.pack.js"></script><meta name="description" content="漏签真的很烦。
前言本文仅供学习探讨之用，如果侵犯了您的权益请联系我删除。
工具
Fiddler
JADX
IDA
Frida

抓包
重放测试使用Shift + R进行一个包的重放。

没有问题，这其中有个DS参数看起来挺可疑的，去掉再试试。

服务器直接不认了，那么可以确定这就是个时间戳签名信息。
JADX将apk拖进jadx并等待分析完成后打开搜索窗口直接搜索DS关键字

然后啥也没搜到，那么换个&amp;quot;DS&amp;quot;关键字

看到几个可疑的目标，比如这个圈起来的类名就叫做GetDSMethodImpl，可以说非常的直接，那么跟过去看看

经过分析代码后，发现DS来自与这个函数，继续跟过去看看

可以看到到这里就已经进入了so层了，那么接下来进入下一层的分析。
IDA全部的伪代码比较长，我就截取.."><meta name="generator" content="Hexo 6.1.0"><link rel="alternate" href="/atom.xml" title="Bzi-Han的博客" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">Bzi-Han's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">[逆向] 米游社原神每日签到之DS算法</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">点击返回顶部</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">首页</a></h3><h3 class="is-inline-block"><a href="/about">关于</a></h3><h3 class="is-inline-block"><a href="/archives">归档</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7"><span class="toc-text">工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%93%E5%8C%85"><span class="toc-text">抓包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E6%94%BE%E6%B5%8B%E8%AF%95"><span class="toc-text">重放测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JADX"><span class="toc-text">JADX</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IDA"><span class="toc-text">IDA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E8%BF%87%E7%A8%8B"><span class="toc-text">计算过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E9%AA%8C%E8%AF%81"><span class="toc-text">代码验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E6%B5%8B%E8%AF%95"><span class="toc-text">实际测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9E%E5%88%B0JADX"><span class="toc-text">回到JADX</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TODO"><span class="toc-text">TODO</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AF%AD"><span class="toc-text">结语</span></a></li></ol></div><div class="column is-9"><header class="my-4"></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">[逆向] 米游社原神每日签到之DS算法</h1><time class="has-text-grey" datetime="2022-09-15T02:36:45.000Z">2022-09-15</time><article class="mt-2 post-content"><p>漏签真的很烦。</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文仅供学习探讨之用，如果侵犯了您的权益请联系我删除。</p>
<h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><ol>
<li><a target="_blank" rel="noopener" href="https://www.telerik.com/fiddler" title="Fiddler Official">Fiddler</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/skylot/jadx" title="JADX Official">JADX</a></li>
<li><a target="_blank" rel="noopener" href="https://hex-rays.com/" title="IDA Official">IDA</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/frida/frida" title="Frida Official">Frida</a></li>
</ol>
<h2 id="抓包"><a href="#抓包" class="headerlink" title="抓包"></a>抓包</h2><p><img src="/images/1650222132.jpg" alt="签到包内容"></p>
<h2 id="重放测试"><a href="#重放测试" class="headerlink" title="重放测试"></a>重放测试</h2><p>使用<code>Shift + R</code>进行一个包的重放。</p>
<p><img src="/images/1650222133.jpg" alt="重放测试结果"></p>
<p>没有问题，这其中有个<code>DS</code>参数看起来挺可疑的，去掉再试试。</p>
<p><img src="/images/1650222134.jpg" alt="重放测试结果"></p>
<p>服务器直接不认了，那么可以确定这就是个时间戳签名信息。</p>
<h2 id="JADX"><a href="#JADX" class="headerlink" title="JADX"></a>JADX</h2><p>将apk拖进<code>jadx</code>并等待分析完成后打开搜索窗口直接搜索<code>DS</code>关键字</p>
<p><img src="/images/1650222135.jpg" alt="搜索结果"></p>
<p>然后啥也没搜到，那么换个<code>&quot;DS&quot;</code>关键字</p>
<p><img src="/images/1650222136.jpg" alt="搜索结果"></p>
<p>看到几个可疑的目标，比如这个圈起来的类名就叫做<code>GetDSMethodImpl</code>，可以说非常的直接，那么跟过去看看</p>
<p><img src="/images/1650222137.jpg" alt="跟踪结果"></p>
<p>经过分析代码后，发现<code>DS</code>来自与这个函数，继续跟过去看看</p>
<p><img src="/images/1650222138.jpg" alt="跟踪结果"></p>
<p>可以看到到这里就已经进入了<code>so</code>层了，那么接下来进入下一层的分析。</p>
<h2 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h2><p>全部的伪代码比较长，我就截取一小部分先来看看</p>
<pre><code>v4 = (*a1)-&gt;GetStringUTFChars(a1, a3, 0LL); 
v64 = 0LL;
v65 = 0LL;
v66 = 0LL;
v5 = strlen(v4);                             
v6 = v5;
if ( v5 &gt;= 0x17 )
&#123;
    v8 = (v5 + 16) &amp; 0xFFFFFFFFFFFFFFF0LL;
    v7 = (char *)operator new(v8);
    v65 = v6;
    v66 = v7;
    v64 = v8 | 1;
    goto LABEL_5;
&#125;
v7 = (char *)&amp;v64 + 1;
LOBYTE(v64) = 2 * v5;
if ( v5 )
LABEL_5:
    memcpy(v7, v4, v6);                       
v7[v6] = 0;                          
gettimeofday(&amp;tv, 0LL);
std::to_string((std::__ndk1 *)(v63 / 1000000 + *(_QWORD *)&amp;tv), v9);
Random::random((Random *)v58);
std::operator+&lt;char&gt;(&quot;salt=&quot;, &amp;v64);
v10 = std::string::append((int)&amp;v48, &quot;&amp;t=&quot;, 3u);
</code></pre>
<p>可以看到其中大量使用了<code>std::string::append</code>，那么我们来Hook这个函数看看。</p>
<p>需要说明一下的是米游社有<code>Anti-Frida</code>，所以需要反一下，可以参考一下这篇文章：<a target="_blank" rel="noopener" href="http://localhost:4000/2022/09/13/%E7%BC%96%E7%A8%8B-%E5%8F%8DFrida%E6%A3%80%E6%B5%8B%E4%B8%8E%E7%A6%81%E6%AD%A2SSLPinning%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%B7%AF%E5%92%8C%E6%96%B9%E6%B3%95/">反Frida检测与禁止SSLPinning的一些思路和方法</a>。</p>
<p>来看下Hook结果</p>
<p><img src="/images/1650222139.jpg" alt="Hook结果"></p>
<p>可以看到这个结果跟我们抓到的包的<code>DS</code>参数最终效果是一致的</p>
<p><code>DS: 1663216865,2bfm47,b6069f6088a02f2ff35b1407034b520c</code></p>
<p>那么我们根据这个结果再回到IDA进行一波分析逻辑。</p>
<p>经过一番梳理之后得到以下流程</p>
<pre><code>CMD5::CMD5((CMD5 *)&amp;v70);                     // new MD5类
</code></pre>
<hr>
<pre><code>v4 = (*a1)-&gt;GetStringUTFChars(a1, a3, 0LL);   // 获取传进来的salt参数
v64 = 0LL;
v65 = 0LL;
v66 = 0LL;
v5 = strlen(v4);                              // 计算salt的长度
v6 = v5;
if ( v5 &gt;= 0x17 )
&#123;
    v8 = (v5 + 16) &amp; 0xFFFFFFFFFFFFFFF0LL;
    v7 = (char *)operator new(v8);
    v65 = v6;
    v66 = v7;
    v64 = v8 | 1;
    goto LABEL_5;
&#125;
v7 = (char *)&amp;v64 + 1;
LOBYTE(v64) = 2 * v5;
if ( v5 )
LABEL_5:
    memcpy(v7, v4, v6);                         // copy v4(salt字符串)给v64
v7[v6] = 0;                                   // 结尾设\0
gettimeofday(&amp;tv, 0LL);
std::to_string((std::__ndk1 *)(v63 / 1000000 + *(_QWORD *)&amp;tv), v9);
Random::random((Random *)v58);                // 生成随机字符串
std::operator+&lt;char&gt;(&quot;salt=&quot;, &amp;v64);          // 拼接salt=传进来的salt
v10 = std::string::append((int)&amp;v48, &quot;&amp;t=&quot;, 3u);// 拼接&amp;t=
v11 = *(_OWORD *)v10;
v51 = *(void **)(v10 + 16);
v50 = v11;
*(_QWORD *)(v10 + 8) = 0LL;
*(_QWORD *)(v10 + 16) = 0LL;
*(_QWORD *)v10 = 0LL;
if ( (v59 &amp; 1) != 0 )
    v12 = v61;
else
    v12 = v60;
if ( (v59 &amp; 1) != 0 )
    LODWORD(v13) = *(_DWORD *)&amp;v60[7];
else
    v13 = (unsigned __int64)v59 &gt;&gt; 1;
v14 = std::string::append((int)&amp;v50, v12, v13);// 拼接当前时间戳
v15 = *(_OWORD *)v14;
v53 = *(void **)(v14 + 16);
v52 = v15;
*(_QWORD *)(v14 + 8) = 0LL;
*(_QWORD *)(v14 + 16) = 0LL;
*(_QWORD *)v14 = 0LL;
v16 = std::string::append((int)&amp;v52, &quot;&amp;r=&quot;, 3u);// 拼接&amp;r=
v17 = *(_OWORD *)v16;
v71 = *(void **)(v16 + 16);
v70 = v17;
*(_QWORD *)(v16 + 8) = 0LL;
*(_QWORD *)(v16 + 16) = 0LL;
*(_QWORD *)v16 = 0LL;
if ( (v54 &amp; 1) != 0 )
    v18 = v57;
else
    v18 = v55;
if ( (v54 &amp; 1) != 0 )
    LODWORD(v19) = v56;
else
    v19 = (unsigned __int64)v54 &gt;&gt; 1;
v20 = std::string::append((int)&amp;v70, v18, v19);// 拼接随机字符串
v21 = *(_WORD *)(v20 + 5);
v22 = *(_DWORD *)(v20 + 1);
v23 = *(_BYTE *)v20;                          // v23获得待计算字符串所有权
v69 = *(_BYTE *)(v20 + 7);
v68 = v21;
v67 = v22;
v25 = *(_QWORD *)(v20 + 8);
v24 = *(void **)(v20 + 16);
*(_QWORD *)v20 = 0LL;
*(_QWORD *)(v20 + 8) = 0LL;
*(_QWORD *)(v20 + 16) = 0LL;
</code></pre>
<hr>
<pre><code>v40 = 0LL;
v41 = 0LL;
v42 = 0LL;
if ( (v23 &amp; 1) == 0 )
&#123;
    LOBYTE(v40) = v23;                          // v40获得待计算字符串所有权
    HIBYTE(v40) = v69;
    *(_WORD *)((char *)&amp;v40 + 5) = v68;
    *(_DWORD *)((char *)&amp;v40 + 1) = v67;
    v41 = v25;
    v42 = v24;
    goto LABEL_42;
&#125;
</code></pre>
<hr>
<pre><code>CMD5::md5(&amp;v70, &amp;v40);                        // 计算v40 md5hash值
if ( (v43 &amp; 1) != 0 )
    v33 = v45;
else
    v33 = v44;
if ( (v43 &amp; 1) != 0 )
    LODWORD(v34) = *(_DWORD *)&amp;v44[7];
else
    v34 = (unsigned __int64)v43 &gt;&gt; 1;
</code></pre>
<hr>
<pre><code>sub_13C40((int)&amp;v59, &quot;,&quot;);                    // 拼接 当前时间戳 + &quot;,&quot;
if ( (v54 &amp; 1) != 0 )
    v26 = v57;
else
    v26 = v55;
if ( (v54 &amp; 1) != 0 )
    LODWORD(v27) = v56;
else
    v27 = (unsigned __int64)v54 &gt;&gt; 1;
v28 = std::string::append((int)&amp;v46, v26, v27);// 拼接随机字符串
v29 = *(_OWORD *)v28;
ptr = *(void **)(v28 + 16);
v48 = v29;
*(_QWORD *)(v28 + 8) = 0LL;
*(_QWORD *)(v28 + 16) = 0LL;
*(_QWORD *)v28 = 0LL;
v30 = std::string::append((int)&amp;v48, &quot;,&quot;, 1u);// 拼接 ,
</code></pre>
<hr>
<pre><code>v35 = std::string::append((int)&amp;v50, v33, v34);// 拼接hash值，完成整个签名过程
</code></pre>
<h2 id="计算过程"><a href="#计算过程" class="headerlink" title="计算过程"></a>计算过程</h2><p>可能上面看起来会有点乱，接下来总结一下对于<code>DS</code>的计算过程大概是这样的</p>
<pre><code>input salt
input timestamp
input randomString

process params = &quot;salt=&quot; + salt + &quot;&amp;t=&quot; + timestamp + &quot;&amp;r=&quot; + randomString
output hash = md5(params)

output DS = timestamp + &quot;,&quot; + randomString + &quot;,&quot; + hash
</code></pre>
<h2 id="代码验证"><a href="#代码验证" class="headerlink" title="代码验证"></a>代码验证</h2><p>来写一份代码验证一下。</p>
<pre><code>import hashlib
import time
import random

salt = &#39;n0KjuIrKgLHh08LWSCYP0WXlVXaYvV64&#39;
# timestamp = str(int(time.time()))
timestamp = &#39;1663216865&#39;
# randomString = &#39;&#39;.join(random.sample(&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&#39;, 6))
randomString = &#39;2bfm47&#39;

params = &#39;salt=&#123;&#125;&amp;t=&#123;&#125;&amp;r=&#123;&#125;&#39;.format(salt, timestamp, randomString)

md5 = hashlib.md5()
md5.update(params.encode(&#39;utf-8&#39;))
hash = md5.hexdigest()

DS = &#39;&#123;&#125;,&#123;&#125;,&#123;&#125;&#39;.format(timestamp, randomString, hash)

print(&#39;DS&#39;, DS)
</code></pre>
<p>输出</p>
<pre><code>预计输出
1663216865,2bfm47,b6069f6088a02f2ff35b1407034b520c

实际输出
DS 1663216865,2bfm47,b6069f6088a02f2ff35b1407034b520c
</code></pre>
<p>可以看到预想与实际的结果完全一致。</p>
<h2 id="实际测试"><a href="#实际测试" class="headerlink" title="实际测试"></a>实际测试</h2><p>来实际发个包试试吧</p>
<p><img src="/images/1650222140.jpg" alt="测试结果"></p>
<p>嗯，居然不认。根据结果知道我们的推理应该是不会错的，那么我们回到<code>jadx</code>看看是什么情况。</p>
<h2 id="回到JADX"><a href="#回到JADX" class="headerlink" title="回到JADX"></a>回到JADX</h2><p>对<code>a2222</code>这个函数查找引用后看到是有两个地方的</p>
<p><img src="/images/1650222141.jpg" alt="引用情况"></p>
<p>根据代码分析它们所使用的<code>salt</code>非同一个，那么我们需要找一下<code>salt</code>的来源。</p>
<p>经过分析之后我们抠出来了这样一段代码</p>
<pre><code>public class Main &#123;
    public static final int[] iArr = &#123;-90, 114, -70, -74, -108, 222, 60, 66, 90, 72, 84, -102, -76, 120, 84, 216, 222, -114, -68, -66, -14348907, 108, 222, 216, -68, 192, -88, -120, 150, -74, 150, -108&#125;;

    public static void main(String[] args) &#123;
        int i;
        StringBuilder sb = new StringBuilder();
        ArrayList&lt;Number&gt; arrayList = new ArrayList(iArr.length);
        for (int i2 : iArr) &#123;
            if (i2 &lt; 0) &#123;
                i = ((double) (-i2)) &gt;= Math.pow(3.0d, 6.0d) ? (int) (((Math.log(-((double) i2)) / Math.log(3.0d)) - ((double) 6)) + ((double) 48)) : ~i2;
            &#125; else &#123;
                i = (i2 / 3) + 48;
            &#125;
            arrayList.add(Integer.valueOf(i));
        &#125;
        ArrayList arrayList2 = new ArrayList(arrayList.size());
        for (Number number : arrayList) &#123;
            sb.append((char) number.intValue());
            arrayList2.add(sb);
        &#125;
        String sb2 = sb.toString();
        System.out.println(sb2);
    &#125;
&#125;
</code></pre>
<p>执行后得到输出</p>
<pre><code>YVEIkzDFNHLeKXLxzqCA9TzxCpWwbIbk
</code></pre>
<p>然后我们将代码中的<code>salt</code>替换为这个输出之后再来发个包试试</p>
<p><img src="/images/1650222142.jpg" alt="最终测试"></p>
<p>嗯，可以看到服务器已经认可我们的包了，没问题。</p>
<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><ul>
<li><input disabled="" type="checkbox"> Taskcloud版本的自动签到脚本</li>
<li><input disabled="" type="checkbox"> 抓米游币每日签到的接口</li>
<li><input disabled="" type="checkbox"> 抓米游币浏览3个帖子的接口</li>
<li><input disabled="" type="checkbox"> 抓米游币点赞5次的接口</li>
<li><input disabled="" type="checkbox"> 抓米游币分享帖子的接口</li>
</ul>
<p>自动签到脚本慢慢再写，因为Taskcloud目前好像还有点问题，但是还没修。</p>
<p>米游社的其他接口<del>可能不搞</del>。</p>
<p><img src="/images/sticker_!smart.jpg" alt="!smart"></p>
<p>先放脚本的仓库链接，之后如果有新脚本的话都会更新到仓库里。</p>
<p>脚本仓库：<a target="_blank" rel="noopener" href="https://github.com/Bzi-Han/scripts">scripts</a></p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>原神真好玩，嘿嘿。</p>
<p>那就这样了，有缘再见~</p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><em></em><a class="button is-default" href="/2022/09/13/%E7%BC%96%E7%A8%8B-%E5%8F%8DFrida%E6%A3%80%E6%B5%8B%E4%B8%8E%E7%A6%81%E6%AD%A2SSLPinning%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%B7%AF%E5%92%8C%E6%96%B9%E6%B3%95/" title="[编程] 反Frida检测与禁止SSLPinning的一些思路和方法"><span class="has-text-weight-semibold">下一页: [编程] 反Frida检测与禁止SSLPinning的一些思路和方法</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="Bzi-Han/bzi-han.github.io" src="https://utteranc.es/client.js" issue-term="pathname" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/Bzi-Han"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--></section><p><span>Copyright ©</span><span> Bzi-Han 2022</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/post.js"></script></body></html>